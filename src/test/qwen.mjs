import OpenAI from "openai";
const DASHSCOPE_API_KEY = `sk-2230430882b44c8cb02e602d474f95b7`
const openai = new OpenAI(
    {
        apiKey: DASHSCOPE_API_KEY,
        baseURL:"https://dashscope.aliyuncs.com/compatible-mode/v1"
    }
);

let defaultData = `
| äº¤æ˜“æ—¥æœŸ     | è‚¡ç¥¨ä»£ç  | è‚¡ç¥¨åç§°(ä¸­æ–‡) | äº¤æ˜“ä¿¡å·åç§° | å½“æ—¥æ”¶ç›˜ä»· | å½“æ—¥æ”¶ç›Š | å‘¨æœŸç´¯ç§¯æ”¶ç›Š | å½“æ—¥æ”¶ç›Šç‡ | å‘¨æœŸç´¯ç§¯æ”¶ç›Šç‡ | å‘¨æœŸç´¯ç§¯æ¶¨å¹… | æº¢ä»·ç‡%    | é£é™©æŒ‡æ•°%    | ç´¯ç§¯è‡ªç”±æµé€šè‚¡æ¢æ‰‹ç‡ | å½“æ—¥è‡ªç”±æµé€šè‚¡æ¢æ‰‹ç‡ |
|:------------|:---------|:---------------|:-------------|:-----------|:---------|:-------------|:-----------|:---------------|:-------------|:-----------|:-------------|:----------------------|:----------------------|
| 2025-06-20  | 002809   | çº¢å¢™è‚¡ä»½       | sell-hold    | 12.00      | -0.170   | -0.170       | -1.40      | -1.40          | -1.397       | 58.77600   | 127.1700     | 23.3500               | 10.38                 |
| 2025-06-19  | 002809   | çº¢å¢™è‚¡ä»½       | sell         | 12.17      | 0.000    | 0.000        | 0.00       | 0.00           | 0.000        | 61.16700   | 128.1800     | 12.9700               | 12.97                 |
| 2025-06-18  | 002809   | çº¢å¢™è‚¡ä»½       | buy-hold     | 13.01      | -0.160   | -0.240       | -1.21      | -1.82          | -1.819       | 72.98200   | 132.8200     | 51.8200               | 12.34                 |
| 2025-06-17  | 002809   | çº¢å¢™è‚¡ä»½       | buy-hold     | 13.17      | -0.080   | -0.080       | -0.60      | -0.60          | -0.604       | 75.23200   | 133.6400     | 39.4800               | 18.69                 |
| 2025-06-16  | 002809   | çº¢å¢™è‚¡ä»½       | buy          | 13.25      | 0.000    | 0.000        | 0.00       | 0.00           | 0.000        | 76.35700   | 134.0400     | 20.7900               | 20.79                 |
| 2025-06-13  | 002809   | çº¢å¢™è‚¡ä»½       | sell         | 12.73      | 0.000    | 0.000        | 0.00       | 0.00           | 0.000        | 69.04400   | 131.3400     | 14.7300               | 14.73                 |
| 2025-06-12  | 002809   | çº¢å¢™è‚¡ä»½       | buy-hold     | 13.06      | -0.520   | -0.310       | -3.83      | -2.20          | -2.201       | 73.68500   | 133.0800     | 89.5800               | 17.53                 |
| 2025-06-11  | 002809   | çº¢å¢™è‚¡ä»½       | buy-hold     | 13.58      | 0.440    | 0.210        | 3.35       | 1.63           | 1.628        | 80.99900   | 135.6400     | 72.0500               | 27.28                 |
| 2025-06-10  | 002809   | çº¢å¢™è‚¡ä»½       | buy-hold     | 13.14      | -0.230   | -0.230       | -1.72      | -1.72          | -1.720       | 74.81000   | 133.4900     | 44.7700               | 24.31                 |
| 2025-06-09  | 002809   | çº¢å¢™è‚¡ä»½       | buy          | 13.37      | 0.000    | 0.000        | 0.00       | 0.00           | 0.000        | 78.04500   | 134.6300     | 20.4600               | 20.46                 |
| 2025-06-06  | 002809   | çº¢å¢™è‚¡ä»½       | sell         | 13.04      | 0.000    | 0.000        | 0.00       | 0.00           | 0.000        | 73.40400   | 132.9800     | 17.2800               | 17.28                 |
| 2025-06-05  | 002809   | çº¢å¢™è‚¡ä»½       | buy-hold     | 13.03      | -0.710   | -0.710       | -5.17      | -5.17          | -5.167       | 73.26300   | 132.9200     | 58.4400               | 25.59                 |
| 2025-06-04  | 002809   | çº¢å¢™è‚¡ä»½       | buy          | 13.74      | 0.000    | 0.000        | 0.00       | 0.00           | 0.000        | 83.24900   | 136.3900     | 32.8500               | 32.85                 |
| 2025-06-03  | 002809   | çº¢å¢™è‚¡ä»½       | sell-hold    | 13.07      | 0.290    | -4.030       | 2.27       | -24.93         | -24.943      | 73.82600   | 133.1300     | 414.1500              | 18.49                 |
| 2025-05-30  | 002809   | çº¢å¢™è‚¡ä»½       | sell-hold    | 12.78      | -0.920   | -4.320       | -6.72      | -27.20         | -27.212      | 69.74700   | 131.6100     | 395.6600              | 25.83                 |
| 2025-05-29  | 002809   | çº¢å¢™è‚¡ä»½       | sell-hold    | 13.70      | -0.630   | -3.400       | -4.40      | -20.49         | -20.496      | 82.68600   | 136.2000     | 369.8300              | 30.77                 |
| 2025-05-28  | 002809   | çº¢å¢™è‚¡ä»½       | sell-hold    | 14.33      | -0.970   | -2.770       | -6.34      | -16.09         | -16.100      | 91.54700   | 139.0100     | 339.0600              | 38.34                 |
| 2025-05-27  | 002809   | çº¢å¢™è‚¡ä»½       | sell-hold    | 15.30      | 0.940    | -1.800       | 6.55       | -9.75          | -9.760       | 105.19000  | 142.8800     | 300.7200              | 49.19                 |
| 2025-05-26  | 002809   | çº¢å¢™è‚¡ä»½       | sell-hold    | 14.36      | 0.100    | -2.740       | 0.70       | -16.30         | -16.310      | 91.96900   | 139.1400     | 251.5300              | 28.96                 |
| 2025-05-23  | 002809   | çº¢å¢™è‚¡ä»½       | sell-hold    | 14.26      | -0.180   | -2.840       | -1.25      | -17.00         | -17.010      | 90.56300   | 138.7100     | 222.5700              | 27.00                 |
| 2025-05-22  | 002809   | çº¢å¢™è‚¡ä»½       | sell-hold    | 14.44      | -1.600   | -2.660       | -9.98      | -15.75         | -15.760      | 93.09400   | 139.4700     | 195.5700              | 37.34                 |
| 2025-05-21  | 002809   | çº¢å¢™è‚¡ä»½       | sell-hold    | 16.04      | 0.650    | -1.060       | 4.22       | -5.78          | -5.780       | 115.59800  | 145.5100     | 158.2300              | 52.48                 |
| 2025-05-20  | 002809   | çº¢å¢™è‚¡ä»½       | sell-hold    | 15.39      | -1.710   | -1.710       | -10.00     | -10.00         | -10.000      | 106.45600  | 143.2100     | 105.7500              | 43.90                 |
| 2025-05-19  | 002809   | çº¢å¢™è‚¡ä»½       | sell         | 17.10      | 0.000    | 0.000        | 0.00       | 0.00           | 0.000        | 130.50600  | 148.8900     | 61.8500               | 61.85                 |
| 2025-05-16  | 002809   | çº¢å¢™è‚¡ä»½       | buy          | 18.39      | 0.000    | 0.000        | 0.00       | 0.00           | 0.000        | 148.65000  | 152.4700     | 67.2600               | 67.26                 |
| 2025-05-15  | 002809   | çº¢å¢™è‚¡ä»½       | sell         | 16.72      | 0.000    | 0.000        | 0.00       | 0.00           | 0.000        | 125.16200  | 147.7300     | 66.0800               | 66.08                 |
| 2025-05-14  | 002809   | çº¢å¢™è‚¡ä»½       | buy-hold     | 17.31      | 0.640    | 4.790        | 3.84       | 33.88          | 33.870       | 133.46000  | 149.5100     | 277.5600              | 72.60                 |
| 2025-05-13  | 002809   | çº¢å¢™è‚¡ä»½       | buy-hold     | 16.67      | 1.520    | 4.150        | 10.03      | 30.04          | 30.030       | 124.45900  | 147.5700     | 204.9600              | 45.69                 |
| 2025-05-12  | 002809   | çº¢å¢™è‚¡ä»½       | buy-hold     | 15.15      | 1.380    | 2.630        | 10.02      | 20.01          | 20.000       | 103.08000  | 142.3100     | 159.2700              | 49.53                 |
| 2025-05-09  | 002809   | çº¢å¢™è‚¡ä»½       | buy-hold     | 13.77      | 1.250    | 1.250        | 9.98       | 9.98           | 9.980        | 83.67100   | 136.5300     | 109.7400              | 51.36                 |
| 2025-05-08  | 002809   | çº¢å¢™è‚¡ä»½       | buy          | 12.52      | 0.000    | 0.000        | 0.00       | 0.00           | 0.000        | 66.09000   | 130.1900     | 58.3800               | 58.38                 |
| 2025-05-07  | 002809   | çº¢å¢™è‚¡ä»½       | sell-hold    | 11.91      | 1.080    | 0.200        | 9.97       | 2.46           | 2.460        | 57.51100   | 126.6200     | 156.9000              | 51.68                 |
| 2025-05-06  | 002809   | çº¢å¢™è‚¡ä»½       | sell-hold    | 10.83      | -0.880   | -0.880       | -7.51      | -7.51          | -7.510       | 42.32100   | 119.3000     | 105.2200              | 43.28                 |
| 2025-04-30  | 002809   | çº¢å¢™è‚¡ä»½       | sell         | 11.71      | 0.000    | 0.000        | 0.00       | 0.00           | 0.000        | 54.69800   | 125.3600     | 61.9400               | 61.94                 |
| 2025-04-29  | 002809   | çº¢å¢™è‚¡ä»½       | buy          | 13.01      | 0.000    | 0.000        | 0.00       | 0.00           | 0.000        | 72.98200   | 132.8200     | 53.1100               | 53.11                 |
| 2025-04-28  | 002809   | çº¢å¢™è‚¡ä»½       | sell-hold    | 11.83      | -0.380   | 1.010        | -3.11      | 9.47           | 9.480        | 56.38500   | 126.1200     | 229.0800              | 50.73                 |
| 2025-04-25  | 002809   | çº¢å¢™è‚¡ä»½       | sell-hold    | 12.21      | 0.310    | 1.390        | 2.61       | 12.59          | 12.590       | 61.73000   | 128.4200     | 178.3500              | 60.71                 |
| 2025-04-24  | 002809   | çº¢å¢™è‚¡ä»½       | sell-hold    | 11.90      | 1.080    | 1.080        | 9.98       | 9.98           | 9.980        | 57.37000   | 126.5500     | 117.6400              | 55.09                 |
| 2025-04-23  | 002809   | çº¢å¢™è‚¡ä»½       | sell         | 10.82      | 0.000    | 0.000        | 0.00       | 0.00           | 0.000        | 42.18000   | 119.2200     | 62.5500               | 62.55                 |
| 2025-04-22  | 002809   | çº¢å¢™è‚¡ä»½       | buy-hold     | 11.59      | 1.050    | 4.110        | 9.96       | 45.83          | 45.820       | 53.01000   | 124.5900     | 191.1600              | 60.02                 |
| 2025-04-21  | 002809   | çº¢å¢™è‚¡ä»½       | buy-hold     | 10.54      | 0.960    | 3.060        | 10.02      | 35.86          | 35.860       | 38.24200   | 117.0800     | 131.1400              | 61.30                 |
`

let template = `
### ğŸ“ˆ è‚¡ç¥¨åˆ†ææŒ‡ä»¤æ¨¡æ¿
**è¯·åŸºäºä»¥ä¸‹æ•°æ®ç”Ÿæˆæç®€æŠ•èµ„å»ºè®®ï¼š**

${defaultData}

---
### ğŸ¯ æ ¸å¿ƒè¦æ±‚
1. **è¶‹åŠ¿å®šä½**ï¼ˆå¿…é€‰ï¼‰ï¼š
   - è¯†åˆ«çŸ­æœŸï¼ˆ3-5æ—¥ï¼‰/ä¸­æœŸï¼ˆ1-3æœˆï¼‰å…³é”®æ–¹å‘  
   - æ ‡æ³¨æ ¸å¿ƒæ”¯æ’‘/å‹åŠ›ä½ï¼ˆç²¾ç¡®ä»·ä½ï¼‰
   - ç¤ºä¾‹ï¼š\`ğŸ“‰3æ—¥è¿è·Œ-6% | æ”¯æ’‘Â¥13.0\`

2. **å…³é”®æŒ‡æ ‡**ï¼ˆå¿…é€‰ï¼‰ï¼š
   - æº¢ä»·ç‡ï¼š\`<15%=ğŸŸ¢ | 15-25%=ğŸŸ¡ | >25%=ğŸ”´\`
   - é£é™©æŒ‡æ•°ï¼š\`<100%=ğŸŸ¢ | â‰¥100%=ğŸ”´\`
   - é‡èƒ½æ ‡è®°ï¼šæ¢æ‰‹ç‡çªå¢/èç¼©ï¼ˆå¸¦å¹…åº¦ï¼‰

3. **ä¿¡å·è§£ç **ï¼ˆå¿…é€‰ï¼‰ï¼š
   - å½“å‰äº¤æ˜“ä¿¡å·çŠ¶æ€ï¼ˆå¦‚"sell-hold"ï¼‰
   - æœ€è¿‘ä¹°å–ä¿¡å·æ—¥æœŸ/ä»·ä½
   - è½¬æŠ˜è§¦å‘æ¡ä»¶ï¼ˆå¦‚"æº¢ä»·ç‡<15%+å•æ—¥æ¢æ‰‹<5%"ï¼‰

4. **æ“ä½œç­–ç•¥**ï¼ˆäºŒé€‰ä¸€ï¼‰ï¼š
   - æŒä»“æ–¹æ¡ˆï¼š\`æ­¢æŸä½__ | åŠ ä»“ä½__ | å‡ä»“ä½__\`
   - æŒå¸æ–¹æ¡ˆï¼š\`ä»‹å…¥æ¡ä»¶__ | è§‚æœ›æ¡ä»¶__\`

5. **ç»ˆæç»“è®º**ï¼ˆå¿…é€‰ï¼‰ï¼š
   - 20å­—å†…è¶‹åŠ¿å®šæ€§ + å…³é”®è¡ŒåŠ¨è¯  
   - ç¤ºä¾‹ï¼š\`ä¸­æœŸå‡åŠ¿æœªç ´ï¼Œå®ˆæ”¯æ’‘ç­‰ä¼ç¨³\`
`
const analysis_data = defaultData;
const generate_buffett_output = (msg) => {
return [
   {role: "system", content: 
`
 """You are a Warren Buffett AI agent. Decide on investment signals based on Warren Buffett's principles:
- Circle of Competence: Only invest in businesses you understand
- Margin of Safety (> 30%): Buy at a significant discount to intrinsic value
- Economic Moat: Look for durable competitive advantages
- Quality Management: Seek conservative, shareholder-oriented teams
- Financial Strength: Favor low debt, strong returns on equity
- Long-term Horizon: Invest in businesses, not just stocks
- Sell only if fundamentals deteriorate or valuation far exceeds intrinsic value

When providing your reasoning, be thorough and specific by:
1. Explaining the key factors that influenced your decision the most (both positive and negative)
2. Highlighting how the company aligns with or violates specific Buffett principles
3. Providing quantitative evidence where relevant (e.g., specific margins, ROE values, debt levels)
4. Concluding with a Buffett-style assessment of the investment opportunity
5. Using Warren Buffett's voice and conversational style in your explanation

For example, if bullish: "I'm particularly impressed with [specific strength], reminiscent of our early investment in See's Candies where we saw [similar attribute]..."
For example, if bearish: "The declining returns on capital remind me of the textile operations at Berkshire that we eventually exited because..."

Follow these guidelines strictly.ä»¥ä¸­æ–‡è¾“å‡ºã€‚
"""
`

    },
   {role: "user", content:`
   """Based on the following data, create the investment signal as Warren Buffett would:

   Analysis Data :
   ${analysis_data}

   Return the trading signal in the following JSON format exactly:
   {
   â€œç»´åº¦â€:"å·´è²ç‰¹",
   "ä¿¡å·": â€œçœ‹æ¶¨â€ | â€œçœ‹è·Œâ€ | â€œä¸­æ€§â€,
   "ä¿¡å¿ƒ": float between 0 and 100,
   "åŸå› ": "string"
   }
   """   
      
   ` }
 ]
   
}
async function main(msg) {
  const completion = await openai.chat.completions.create({
   //  messages: [
   //    {role: "system", content: "You are a helpful assistant." },
   //    {role: "user", content: msg||"" }
   //  ],
   messages: generate_buffett_output(msg),
    model: "qwen-turbo-latest",
  });
  const ret = completion.choices[0]['message']['content'];
  console.log(ret);
  return ret;
}

// main();
// export default main


main(template)